version: "3.4"

services:
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    # ports:
    #   - 9090:9090
    networks:
      inter_br:

  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    depends_on:
      - prometheus
    volumes:
      - ./config/grafana/grafana.ini:/etc/grafana/grafana.ini
      - grafana_data:/var/lib/grafana
    networks:
      inter_br:

  pihole:
    image: pihole/pihole:latest
    restart: unless-stopped
    volumes:
      - pihole_dnsmasq:/etc/dnsmasq.d
      - ./config/pihole/data:/etc/pihole
    environment:
      TZ: "America/Toronto"
      WEBPASSWORD: "pihole_access"
    dns:
      - 127.0.0.1
      - 1.1.1.1
    networks:
      inter_br:
      dns_br:
        ipv4_address: 10.5.0.5

  pihole_monitoring:
    image: ekofr/pihole-exporter:latest
    restart: unless-stopped
    environment:
      PIHOLE_HOSTNAME: "pihole"
      PIHOLE_PASSWORD: "pihole_access"
      INTERVAL: "30s"
      PORT: "9617"
    networks:
      inter_br:

  coredns:
    image: coredns/coredns:latest
    depends_on:
      - pihole
    volumes:
      - ./config/coredns/Corefile:/Corefile
    restart: unless-stopped
    ports:
      - 53:53/udp
    networks:
      inter_br:
      dns_br:
        ipv4_address: 10.5.0.6

  # doh_proxy:
  #   build: ./config/doh_proxy
  #   depends_on:
  #     - coredns
  #   networks:
  #     inter_br:
  #     dns_br:
  #       ipv4_address: 10.5.0.7

  dnsdist:
    build: ./config/dnsdist
    tty: true
    stdin_open: true
    restart: unless-stopped
    depends_on:
      - coredns
    command: ["-C", "/etc/dnsdist/dnsdist.conf", "--verbose"]
    volumes:
      - ./config/dnsdist/dnsdist.conf:/etc/dnsdist/dnsdist.conf:ro
    networks:
      inter_br:
      dns_br:
        ipv4_address: 10.5.0.7

  caddy:
    image: caddy:2
    depends_on:
      - grafana
      - pihole
      - dnsdist
    restart: unless-stopped
    volumes:
      - caddy_config:/config
      - caddy_data:/data
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile
    ports:
      - 443:443
    networks:
      inter_br:

  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node_exporter
    command:
      - "--path.rootfs=/host"
    pid: host
    restart: unless-stopped
    volumes:
      - "/:/host:ro,rslave"
    networks:
      inter_br:

  speedtest_exporter:
    image: jraviles/prometheus_speedtest:latest
    container_name: speedtest_exporter
    restart: unless-stopped
    networks:
      inter_br:

  # openvpn:
  #   cap_add:
  #     - NET_ADMIN
  #   image: kylemanna/openvpn
  #   ports:
  #     - 80:1194
  #   restart: always
  #   volumes:
  #     - ./config/openvpn/data:/etc/openvpn
  #     - ./config/openvpn/tmp:/tmp
  #   networks:
  #     inter_br:
  # openvpn_monitoring:
  #   image: kumina/openvpn-exporter
  #   depends_on:
  #     - openvpn
  #   volumes:
  #     - ./config/openvpn/tmp/openvpn-status.log:/etc/openvpn_exporter/server.status:ro
  #   command: /bin/openvpn_exporter -openvpn.status_paths /etc/openvpn_exporter/server.status

volumes:
  prometheus_data:
  caddy_config:
  caddy_data:
  grafana_data:
  pihole_dnsmasq:

networks:
  inter_br:
    driver: bridge
  dns_br:
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/16
